

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>AEcroscopy Manuscript Measurements Workflow &#8212; AEcroscopy</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'AEcroscopy_manuscript';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/LOGO.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/LOGO.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to AEcroscopy for Automated and Autonomous Microscopy
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="python_guide/intro.html">Introduction to AEcroscopy</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="python_guide/introduction_notebook.html">Guide to Essential Commands and Functionalities in AEcroscopy</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="ht_workflows/ht.html">High Throughput Experimentation</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="ht_workflows/ht_domain_writing_experiment.html">High Throughput Domain Writing Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="ht_workflows/ht_domain_writing_analysis.html">Notebook for high throughput domain writing analysis</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/yongtaoliu/Aecroscopy" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/yongtaoliu/Aecroscopy/issues/new?title=Issue%20on%20page%20%2FAEcroscopy_manuscript.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/AEcroscopy_manuscript.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>AEcroscopy Manuscript Measurements Workflow</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-and-import">Install and Import</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#start-bepyae-exe-and-set-vi">Start BEPyAE.exe and set VI</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initialize-igor-ar18">Initialize Igor AR18</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-tip-parameters">Set tip parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-io">Set IO</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-be-pulse-parameters">Set BE pulse parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#be-line-scan">BE Line scan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#be-raster-scan">BE Raster Scan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-1-high-throughput-domain-writing-in-ferroelectric-materials">Experiment 1. High-throughput domain writing in ferroelectric materials</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prior-to-expeirment-set-a-directory-to-save-data">Prior to expeirment, set a directory to save data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-generate-a-location-array">Step 1. Generate a location array</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-establish-pulse-parameters">Step 2. Establish pulse parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-start-experiment">Step 3. Start experiment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-do-a-bepfm-at-the-whole-experiment-area">Step 4. Do a BEPFM at the whole experiment area</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-2-ferroelectric-domain-wall-width-as-a-function-of-drive-amplitude-and-setpoint">Experiment 2. Ferroelectric Domain Wall Width as a Function of Drive Amplitude and Setpoint</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Prior to expeirment, set a directory to save data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-establish-ac-amplitude-and-setpoint-parameters">Step 1. Establish AC Amplitude and Setpoint Parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-write-a-domain-wall">Step 2. Write a Domain Wall</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-perform-bepfm-to-image-the-domain-wall-with-various-ac-and-setpoint">Step 3. Perform BEPFM to image the domain wall with various AC and setpoint</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-3-spiral-scans">Experiment 3. Spiral Scans</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Prior to expeirment, set a directory to save data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-set-be-pulse-parameters">Step 1. Set BE pulse parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-perform-a-raster-scan-as-a-reference-to-compare-with-spiral-and-lissajour-scan-results">Step 2. Perform a raster scan as a reference to compare with spiral and lissajour scan results.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-perform-a-spiral-scan-bepfm">Step 3. Perform a spiral scan BEPFM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-4-spectroscopy-measurements-at-specific-objects">Experiment 4. Spectroscopy Measurements at Specific Objects</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Prior to expeirment, set a directory to save data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-perform-a-bepfm-to-image-domain-structures">Step 1. Perform a BEPFM to image domain structures</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-apply-a-threshold-filter-to-extract-a-domain-location-from-amplitude-image">Step 2. Apply a threshold filter to extract a-domain location from amplitude image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-perform-beps-measurements-at-selected-locations">Step 3. Perform BEPS measurements at selected locations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-2-perform-grid-beps-measurements">Step 3-2. Perform grid BEPS measurements</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="aecroscopy-manuscript-measurements-workflow">
<h1>AEcroscopy Manuscript Measurements Workflow<a class="headerlink" href="#aecroscopy-manuscript-measurements-workflow" title="Permalink to this heading">#</a></h1>
<p><span class="math notranslate nohighlight">\({Yongtao}\)</span> <span class="math notranslate nohighlight">\({Liu}\)</span></p>
<p><span class="math notranslate nohighlight">\({June}\)</span> <span class="math notranslate nohighlight">\({2023}\)</span></p>
<section id="install-and-import">
<h2>Install and Import<a class="headerlink" href="#install-and-import" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">win32com.client</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">sidpy</span>
<span class="kn">import</span> <span class="nn">pyNSID</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># import acquition.py</span>
<span class="kn">from</span> <span class="nn">Acquisition_v0_9</span> <span class="kn">import</span> <span class="n">Acquisition</span>   <span class="c1"># include the Acquistion_v.py in the same directory</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="start-bepyae-exe-and-set-vi">
<h2>Start BEPyAE.exe and set VI<a class="headerlink" href="#start-bepyae-exe-and-set-vi" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Start BEPyAE.ext</p></li>
<li><p>Set VI of BEPyAE; if this version includes PyScanner, also set VIs for PyScanner</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">newexp</span> <span class="o">=</span> <span class="n">Acquisition</span><span class="p">(</span><span class="n">exe_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\Asylum User\Desktop\Yongtao_Desktop\BEPyAE 060523 01\BEPyAE.exe&quot;</span><span class="p">)</span>   
<span class="c1"># exe_path is the directory of BEPyAE; </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">newexp</span> <span class="o">=</span> <span class="n">Acquisition</span><span class="p">(</span><span class="n">exe_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\Asylum User\Desktop\Yongtao_Desktop\BEPyAE 060523 01\BEPyAE.exe&quot;</span><span class="p">)</span>

<span class="nn">File ~\Aecroscopy_local\Acquisition_v0_9.py:32,</span> in <span class="ni">Acquisition.__init__</span><span class="nt">(self, exe_path, client, pyae_vi, pyscanner_vi)</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span> <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span><span class="sd"> Initializes the Acquistion class and starts BEPyAE.exe.</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span><span class="sd">     pyscanner_vi (str): Path to the Pyscanner VI.</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span><span class="sd"> &quot;&quot;&quot;</span> 
<span class="g g-Whitespace">     </span><span class="mi">31</span> <span class="c1"># Start BEPyAE</span>
<span class="ne">---&gt; </span><span class="mi">32</span> <span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">exe_path</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span> <span class="c1"># Wait until BEPyAE.exe starts, then set VI reference &#39;BEPyAE.vi&#39;</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span> <span class="n">bepyae_not_start</span> <span class="o">=</span> <span class="kc">True</span>

<span class="ne">FileNotFoundError</span>: [WinError 2] The system cannot find the file specified: &#39;C:\\Users\\Asylum User\\Desktop\\Yongtao_Desktop\\BEPyAE 060523 01\\BEPyAE.exe&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="initialize-igor-ar18">
<h2>Initialize Igor AR18<a class="headerlink" href="#initialize-igor-ar18" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Set offline development</p></li>
<li><p>Build a connection between BEPyAE and AR18</p></li>
<li><p>Get parameters in AR18</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">newexp</span><span class="o">.</span><span class="n">init_BEPyAE</span><span class="p">(</span><span class="n">offline_development</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># set offline_development=True if doing offline development</span>
                                                <span class="c1"># executing this will also initlize AR18</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>Hereinafter</p>
<ul class="simple">
<li><p>If no parameters are provided in a function, executing the function will utilize the default parameters within <span class="math notranslate nohighlight">\(BEPyAE.exe\)</span>.</p></li>
<li><p>Certain functions provide feedback after execution, which can be disabled by setting <span class="math notranslate nohighlight">\(feedbackon=False\)</span>. This allows you to deactivate feedback during specific iterations or instances when it is not required.</p></li>
<li><p>Note: For tip locations, -1 corresponds to the left-hand side on the x-axis and the bottom side on the y-axis, while 1 corresponds to the right-hand side on the x-axis and the top side on the y-axis.</p></li>
</ul>
</div></blockquote>
</section>
<section id="set-tip-parameters">
<h2>Set tip parameters<a class="headerlink" href="#set-tip-parameters" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>set setpoint, tip locations</p></li>
</ul>
<p><img alt="image1.PNG" src="../ht_workflows/image1.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">newexp</span><span class="o">.</span><span class="n">tip_control</span><span class="p">(</span><span class="n">tip_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;set_point_V_00&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;next_x_pos_00&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;next_y_pos_01&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                   <span class="n">do_move_tip</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                   <span class="n">do_set_setpoint</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># Executing this code will set setpoint to 1 V, </span>
                                           <span class="c1"># and move tip to location [0, 0.5]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Setpoint is:  1.0
Tip parameters are:  (0.0, 0.0, 0.2)
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-io">
<h2>Set IO<a class="headerlink" href="#set-io" title="Permalink to this heading">#</a></h2>
<p>This defines IO parameters, such as AFM platform: AR18, amplifiers, channel data types, etc</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">newexp</span><span class="o">.</span><span class="n">define_io_cluster</span><span class="p">(</span><span class="n">IO_cluster_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;analog_output_amplifier_06&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
                                                  <span class="s2">&quot;channel_01_type_07&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
                                                  <span class="s2">&quot;channel_02_type_08&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                                  <span class="s2">&quot;channel_03_type_09&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;0 Cypher AR18&#39;,
 &#39;6124&#39;,
 4000000.0,
 10.0,
 10.0,
 &#39;AC and DC on AO0&#39;,
 10.0,
 &#39;topography&#39;,
 &#39;current&#39;,
 &#39;aux&#39;,
 &#39;external&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-be-pulse-parameters">
<h2>Set BE pulse parameters<a class="headerlink" href="#set-be-pulse-parameters" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set BE parameters</span>
<span class="n">newexp</span><span class="o">.</span><span class="n">define_be_parms</span><span class="p">(</span><span class="n">be_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;center_frequency_Hz_00&quot;</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span> <span class="s2">&quot;band_width_Hz_01&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;amplitude_V_02&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
                                        <span class="s2">&quot;phase_variation_03&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;repeats_04&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;req_pulse_duration_s_05&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                                        <span class="s2">&quot;auto_smooth_ring_06&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                       <span class="n">do_create_be_waveform</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BE parameters are:  (350000.0, 100000.0, 1.0, 1.0, 4, 0.004, 1, 3352.2952763920002, 0.12159459061880915)
</pre></div>
</div>
</div>
</div>
</section>
<section id="be-line-scan">
<h2>BE Line scan<a class="headerlink" href="#be-line-scan" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>This is a single BE line scan</p></li>
<li><p>This returns 5 datasets: quick_fitting, complex spectra, and 3 channels</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;D:\WEST User data\Yongtao\AEcroscopy\Experiment3&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do a single line scan</span>
<span class="n">qk_fit</span><span class="p">,</span> <span class="n">com_spec</span><span class="p">,</span> <span class="n">chn1</span><span class="p">,</span> <span class="n">chn2</span><span class="p">,</span> <span class="n">chn3</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">do_line_scan</span><span class="p">(</span><span class="n">line_scan_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;num_BE_pulses_01&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
                                                                                 <span class="s2">&quot;start_x_pos_00&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;start_y_pos_01&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                                 <span class="s2">&quot;stop_x_pos_02&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;stop_y_pos_03&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                                                         <span class="n">upload_to_daq</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">do_line_scan</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>voltage offset and number of BE pulse are:  (0.0, 32)
line scan start and end positions:  (-1.0, -1.0, 1.0, 1.0)
</pre></div>
</div>
</div>
</div>
</section>
<section id="be-raster-scan">
<h2>BE Raster Scan<a class="headerlink" href="#be-raster-scan" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Square raster scan</p></li>
<li><p>raster_scan returns 3 sidpy datasets: BEPFM quick fitting, channels, and BE complex spectra</p></li>
<li><p>raster_scan also saves these 3 sidpy dataset in a hdf5 file</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do a 128*128 raster scan</span>
<span class="n">dset_pfm</span><span class="p">,</span> <span class="n">dset_chns</span><span class="p">,</span> <span class="n">dset_cs</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">raster_scan</span><span class="p">(</span><span class="n">raster_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scan_pixel&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;scan_x_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                                       <span class="s2">&quot;scan_y_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;scan_x_stop&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                                                       <span class="s2">&quot;scan_y_stop&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> 
                                                  <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;BEPFM_3um&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fefab8f67452052a4df38608d4075687a6549c08b0997c79c75e91d2c2ff6c72.png" src="_images/fefab8f67452052a4df38608d4075687a6549c08b0997c79c75e91d2c2ff6c72.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [progress: 0:01:14] |******                                | (ETA:   0:06:00) 
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="nn">Input In [12],</span> in <span class="ni">&lt;cell line: 2&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Do a 64*64 raster scan</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">dset_pfm</span><span class="p">,</span> <span class="n">dset_chns</span><span class="p">,</span> <span class="n">dset_cs</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">raster_scan</span><span class="p">(</span><span class="n">raster_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scan_pixel&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;scan_x_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                                                                        <span class="s2">&quot;scan_y_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;scan_x_stop&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                                                                        <span class="s2">&quot;scan_y_stop&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> 
<span class="g g-Whitespace">      </span><span class="mi">5</span>                                                   <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;BEPFM_3um&quot;</span><span class="p">)</span>

<span class="nn">File ~\Desktop\Yongtao_Desktop\Acquisition_v0_9.py:676,</span> in <span class="ni">Acquisition.raster_scan</span><span class="nt">(self, file_name, raster_parms_dict, feedbackon, progress_on, ploton)</span>
<span class="g g-Whitespace">    </span><span class="mi">673</span>     <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Wait 0.1 s and check if action is done again</span>
<span class="g g-Whitespace">    </span><span class="mi">675</span> <span class="c1"># Perform line scan at the current position</span>
<span class="ne">--&gt; </span><span class="mi">676</span> <span class="n">line_cx_spectra</span><span class="p">,</span> <span class="n">line_quick_fit</span><span class="p">,</span> <span class="n">line_channel1</span><span class="p">,</span> <span class="n">line_channel2</span><span class="p">,</span> <span class="n">line_channel3</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_line_scan</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">677</span>     <span class="n">line_scan_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;start_x_pos_00&quot;</span><span class="p">:</span> <span class="n">raster_parms_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="g g-Whitespace">    </span><span class="mi">678</span>                             <span class="s2">&quot;start_y_pos_01&quot;</span><span class="p">:</span> <span class="n">scan_line_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;stop_x_pos_02&quot;</span><span class="p">:</span> <span class="n">raster_parms_list</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="g g-Whitespace">    </span><span class="mi">679</span>                             <span class="s2">&quot;stop_y_pos_03&quot;</span><span class="p">:</span> <span class="n">scan_line_array</span><span class="p">[</span><span class="n">i</span><span class="p">]},</span> <span class="n">do_line_scan</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">feedbackon</span> <span class="o">=</span> <span class="n">feedbackon</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">681</span> <span class="c1"># Store the scan data</span>
<span class="g g-Whitespace">    </span><span class="mi">682</span> <span class="n">raster_quick_fit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">line_quick_fit</span><span class="p">))</span>

<span class="nn">File ~\Desktop\Yongtao_Desktop\Acquisition_v0_9.py:588,</span> in <span class="ni">Acquisition.do_line_scan</span><span class="nt">(self, line_scan_parms_dict, upload_to_daq, do_line_scan, feedbackon)</span>
<span class="g g-Whitespace">    </span><span class="mi">586</span> <span class="c1"># Wait until linescan is finished</span>
<span class="g g-Whitespace">    </span><span class="mi">587</span> <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">VI</span><span class="o">.</span><span class="n">getcontrolvalue</span><span class="p">(</span><span class="s1">&#39;BE_line_scan_control_cluster&#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]:</span>
<span class="ne">--&gt; </span><span class="mi">588</span>     <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># wait 0.1 s and check the status again</span>
<span class="g g-Whitespace">    </span><span class="mi">590</span> <span class="c1"># feedback about parameters</span>
<span class="g g-Whitespace">    </span><span class="mi">591</span> <span class="k">if</span> <span class="n">feedbackon</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>Planned Experiment: domain writing, bias-PFM?, â€¦</p>
</section>
<section id="experiment-1-high-throughput-domain-writing-in-ferroelectric-materials">
<h2>Experiment 1. High-throughput domain writing in ferroelectric materials<a class="headerlink" href="#experiment-1-high-throughput-domain-writing-in-ferroelectric-materials" title="Permalink to this heading">#</a></h2>
<blockquote>
<div><p>In this experiment, we begin by applying a DC pulse to switch the ferroelectric polarization. Subsequently, a BEPFM (Band Excitation Piezoresponse Force Microscopy) measurement is conducted to image the domain structure.</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>To initiate the measurement process, we first need to determine the location for each individual measurement.If a new location is chosen for each measurement, we need a location array to record all the measurements as demonstrated below.</p></li>
</ol>
<p><img alt="image2.PNG" src="../ht_workflows/image2.png" /></p>
<ol class="arabic simple" start="2">
<li><p>Prior to experiments, we also need to establish the DC pulse parameters including pulse magnitude <span class="math notranslate nohighlight">\(A\)</span> and pulse length <span class="math notranslate nohighlight">\(t\)</span> , as shown below. Again, there are two scenarios to consider here:</p></li>
</ol>
<p><img alt="image4.PNG" src="../ht_workflows/image4.png" /></p>
<blockquote>
<div><ul class="simple">
<li><p>The pulse parameters can be pre-defined, e.g., the parameter values can be uniformly distributed within a specified range or customized to suit the experimental requirements.</p></li>
<li><p>The pulse parameters can be random values within a defined space, typically these random values is a uniform distribution across that space in principle.</p></li>
</ul>
</div></blockquote>
<section id="prior-to-expeirment-set-a-directory-to-save-data">
<h3>Prior to expeirment, set a directory to save data<a class="headerlink" href="#prior-to-expeirment-set-a-directory-to-save-data" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;C:/AEcroscopy_manuscript/Experiment1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-1-generate-a-location-array">
<h3>Step 1. Generate a location array<a class="headerlink" href="#step-1-generate-a-location-array" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># All locations span across [start_point_x, end_point_x] in x-direction and [start_point_y, end_point_y] in y-direction.</span>
<span class="c1"># There are num_x rows and num_y columns in the locations array</span>

<span class="n">start_point_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9</span>   <span class="c1"># Define location array parameters</span>
<span class="n">end_point_x</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">start_point_y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9</span>
<span class="n">end_point_y</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">num_x</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">num_y</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Generate location array</span>
<span class="n">pos_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">num_x</span><span class="p">)</span>
<span class="n">pos_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">num_y</span><span class="p">)</span>
<span class="n">pulse_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">pos_x</span><span class="p">,</span> <span class="n">pos_y</span><span class="p">)</span>
<span class="n">pulse_pos_x</span> <span class="o">=</span> <span class="n">pulse_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pulse_pos_y</span> <span class="o">=</span> <span class="n">pulse_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># pulse_pos_x and pulse_pos_y are the coordinates of all locations</span>

<span class="c1"># Set BEPFM image size</span>
<span class="n">img_size</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># Check</span>
<span class="k">if</span> <span class="n">img_size</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Alert: there will be image overlap along x-direction&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">img_size</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Alert: there will be image overlap along y-direction&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> locations are ready for experiments&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pulse_pos_x</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-2-establish-pulse-parameters">
<h3>Step 2. Establish pulse parameters<a class="headerlink" href="#step-2-establish-pulse-parameters" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># uniformly distributed pulse parameters</span>
<span class="n">min_voltage</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">max_voltage</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">Vdc_amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_voltage</span><span class="p">,</span> <span class="n">max_voltage</span><span class="p">,</span> <span class="n">num_x</span><span class="p">)</span>  <span class="c1"># pulse magnitude</span>

<span class="n">min_time_log</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>
<span class="n">max_time_log</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">Vdc_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_time_log</span><span class="p">,</span> <span class="n">max_time_log</span><span class="p">,</span> <span class="n">num_y</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">())</span>
<span class="n">Vdc_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Vdc_time</span><span class="p">)</span>                 <span class="c1"># pulse time</span>

<span class="c1"># Establish pulse parameters</span>
<span class="n">Vdc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">Vdc_amp</span><span class="p">,</span> <span class="n">Vdc_time</span><span class="p">)</span>
<span class="n">Vdc_amp</span> <span class="o">=</span> <span class="n">Vdc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Vdc_time</span> <span class="o">=</span> <span class="n">Vdc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Vdc_amp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pulse_pos_x</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Error: No enough locations to test all pulse conditions&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> pulse parameters are ready for expierments&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Vdc_amp</span><span class="p">)))</span>
    
<span class="c1"># save pulse condition</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;Vdc_list.npy&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">Vdc_amp</span><span class="p">,</span> <span class="n">Vdc_time</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-3-start-experiment">
<h3>Step 3. Start experiment<a class="headerlink" href="#step-3-start-experiment" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Vdc_amp</span><span class="p">))):</span>
    <span class="c1">#####################----------- Move tip to the pulse location -----------##################### </span>
    <span class="n">newexp</span><span class="o">.</span><span class="n">tip_control</span><span class="p">(</span><span class="n">tip_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;set_point_V_00&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                         <span class="s2">&quot;next_x_pos_00&quot;</span><span class="p">:</span> <span class="n">pulse_pos_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                         <span class="s2">&quot;next_y_pos_01&quot;</span><span class="p">:</span> <span class="n">pulse_pos_y</span><span class="p">[</span><span class="n">i</span><span class="p">]},</span>
                       <span class="n">do_move_tip</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">do_set_setpoint</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    
    <span class="c1">#####################----------- Apply pulse -----------##################### </span>
    <span class="n">V_amp</span> <span class="o">=</span> <span class="n">Vdc_amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">V_time</span> <span class="o">=</span> <span class="n">Vdc_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
<span class="c1">#     # upload pulse</span>
<span class="c1">#     newexp.define_apply_pulse(pulse_parms_dict = {&quot;pulse_init_amplitude_V_00&quot;: 0, &quot;pulse_mid_amplitude_V_01&quot;: V_amp,</span>
<span class="c1">#                                                   &quot;pulse_final_amplitude_V_02&quot;: 0, &quot;pulse_on_duration_s_03&quot;: V_time,</span>
<span class="c1">#                                                   &quot;rise_time_s_05&quot;: 1E-4, &quot;pulse_final_duration_s_04&quot;: 20E-3,</span>
<span class="c1">#                                                   &quot;pulse_repeats_06&quot;: 1},</span>
<span class="c1">#                               do_create_pulse = True, do_upload_pulse = True, do_apply_pulse = False)</span>
<span class="c1">#     time.sleep(1)</span>
    <span class="c1"># upload and apply pulse</span>
    <span class="n">pulse</span> <span class="n">value</span><span class="p">,</span> <span class="n">pulse_time</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">define_apply_pulse</span><span class="p">(</span><span class="n">pulse_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pulse_init_amplitude_V_00&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                                                                            <span class="s2">&quot;pulse_mid_amplitude_V_01&quot;</span><span class="p">:</span> <span class="n">V_amp</span><span class="p">,</span>
                                                                            <span class="s2">&quot;pulse_final_amplitude_V_02&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                                                                            <span class="s2">&quot;pulse_on_duration_s_03&quot;</span><span class="p">:</span> <span class="n">V_time</span><span class="p">,</span>
                                                                            <span class="s2">&quot;rise_time_s_05&quot;</span><span class="p">:</span> <span class="mf">1E-4</span><span class="p">,</span> 
                                                                            <span class="s2">&quot;pulse_final_duration_s_04&quot;</span><span class="p">:</span> <span class="mf">20E-3</span><span class="p">,</span>
                                                                            <span class="s2">&quot;pulse_repeats_06&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                                                        <span class="n">do_create_pulse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">do_upload_pulse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">do_apply_pulse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">f1</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">f1</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Applied pulse&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pulse_time</span><span class="p">,</span> <span class="n">pulse_value</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Voltage (V)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#####################----------- Do BEPFM to image domain -----------#####################</span>
    <span class="n">dset_pfm</span><span class="p">,</span> <span class="n">dset_chns</span><span class="p">,</span> <span class="n">dset_cs</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">raster_scan</span><span class="p">(</span><span class="n">raster_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scan_pixel&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                                                                           <span class="s2">&quot;scan_x_start&quot;</span><span class="p">:</span> <span class="n">pulse_pos_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">img_size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> 
                                                                           <span class="s2">&quot;scan_y_start&quot;</span><span class="p">:</span> <span class="n">pulse_pos_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">img_size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                                                                           <span class="s2">&quot;scan_x_stop&quot;</span><span class="p">:</span> <span class="n">pulse_pos_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">img_size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> 
                                                                           <span class="s2">&quot;scan_y_stop&quot;</span><span class="p">:</span> <span class="n">pulse_pos_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">img_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)},</span>
                                                      <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;Domain_Writing_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> 
                                                      <span class="n">progress_on</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ploton</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    
    <span class="c1"># Plot BEPFM images</span>
    <span class="n">f2</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">,</span> <span class="n">ax6</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Q Factor&quot;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_chns</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Topography&quot;</span><span class="p">)</span>
    <span class="n">ax6</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_chns</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Deflection&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-4-do-a-bepfm-at-the-whole-experiment-area">
<h3>Step 4. Do a BEPFM at the whole experiment area<a class="headerlink" href="#step-4-do-a-bepfm-at-the-whole-experiment-area" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dset_pfm</span><span class="p">,</span> <span class="n">dset_chns</span><span class="p">,</span> <span class="n">dset_cs</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">raster_scan</span><span class="p">(</span><span class="n">raster_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scan_pixel&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;scan_x_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
                                                                       <span class="s2">&quot;scan_y_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="s2">&quot;scan_x_stop&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                                                                       <span class="s2">&quot;scan_y_stop&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span> 
                                                  <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;PFM_whole&quot;</span><span class="p">,</span> <span class="n">ploton</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">,</span> <span class="n">ax6</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Q Factor&quot;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_chns</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Topography&quot;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_chns</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Deflection&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="experiment-2-ferroelectric-domain-wall-width-as-a-function-of-drive-amplitude-and-setpoint">
<h2>Experiment 2. Ferroelectric Domain Wall Width as a Function of Drive Amplitude and Setpoint<a class="headerlink" href="#experiment-2-ferroelectric-domain-wall-width-as-a-function-of-drive-amplitude-and-setpoint" title="Permalink to this heading">#</a></h2>
<section id="id1">
<h3>Prior to expeirment, set a directory to save data<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;C:/AEcroscopy_manuscript/Experiment2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-1-establish-ac-amplitude-and-setpoint-parameters">
<h3>Step 1. Establish AC Amplitude and Setpoint Parameters<a class="headerlink" href="#step-1-establish-ac-amplitude-and-setpoint-parameters" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># uniformly distributed AC amplitude</span>
<span class="n">min_ac</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">max_ac</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">num_ac</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">Vac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_ac</span><span class="p">,</span> <span class="n">max_ac</span><span class="p">,</span> <span class="n">num_x</span><span class="p">)</span>  <span class="c1"># AC amplitude</span>

<span class="c1"># uniformly distributed setpoint values</span>
<span class="n">min_setpoint</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">max_setpoint</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">num_setpoint</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">setpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_setpoint</span><span class="p">,</span> <span class="n">max_setpoint</span><span class="p">,</span> <span class="n">num_setpoint</span><span class="p">)</span>  <span class="c1"># Setpoint</span>

<span class="c1"># Establish AC and setpoint parameters array</span>
<span class="n">Vac_setpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">Vac</span><span class="p">,</span> <span class="n">setpoint</span><span class="p">)</span>
<span class="n">Vac</span> <span class="o">=</span> <span class="n">Vac_setpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">setpoint</span> <span class="o">=</span> <span class="n">Vac_setpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> AC and setpoint parameters are ready for expierments&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Vac</span><span class="p">)))</span>
    
<span class="c1"># save pulse condition</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;Vac_setpoint.npy&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">Vac</span><span class="p">,</span> <span class="n">setpoint</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-2-write-a-domain-wall">
<h3>Step 2. Write a Domain Wall<a class="headerlink" href="#step-2-write-a-domain-wall" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set AC voltage to 0</span>
<span class="n">newexp</span><span class="o">.</span><span class="n">define_be_parms</span><span class="p">(</span><span class="n">be_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;center_frequency_Hz_00&quot;</span><span class="p">:</span> <span class="mi">335</span><span class="p">,</span> <span class="s2">&quot;band_width_Hz_01&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;amplitude_V_02&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                       <span class="n">do_create_be_waveform</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>  
<span class="c1"># Scan over left half side with -5 V applied to tip to switching polarization, so that a domain wall is writted at the middle</span>
<span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">raster_scan</span><span class="p">(</span><span class="n">raster_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tip_voltage&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;scan_pixel&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;scan_x_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> 
                                                  <span class="s2">&quot;scan_y_start&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scan_x_stop&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;scan_y_stop&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
                             <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;domain_wall_writing&quot;</span><span class="p">,</span> <span class="n">ploton</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-3-perform-bepfm-to-image-the-domain-wall-with-various-ac-and-setpoint">
<h3>Step 3. Perform BEPFM to image the domain wall with various AC and setpoint<a class="headerlink" href="#step-3-perform-bepfm-to-image-the-domain-wall-with-various-ac-and-setpoint" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tpdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Vac</span><span class="p">))):</span>
    <span class="c1"># select AC and setpoint</span>
    <span class="n">be_amp</span> <span class="o">=</span> <span class="n">Vac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">spoint</span> <span class="o">=</span> <span class="n">setpoint</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># Set setpoint</span>
    <span class="n">newexp</span><span class="o">.</span><span class="n">tip_control</span><span class="p">(</span><span class="n">tip_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;set_point_V_00&quot;</span><span class="p">:</span> <span class="n">spoint</span><span class="p">},</span> <span class="n">do_move_tip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">do_set_setpoint</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Set BE pulse amplitude</span>
    <span class="n">newexp</span><span class="o">.</span><span class="n">define_be_parms</span><span class="p">(</span><span class="n">be_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;center_frequency_Hz_00&quot;</span><span class="p">:</span> <span class="mi">335</span><span class="p">,</span> <span class="s2">&quot;band_width_Hz_01&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;amplitude_V_02&quot;</span><span class="p">:</span> <span class="n">be_amp</span><span class="p">},</span>
                           <span class="n">do_create_be_waveform</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Perform BEPFM image measurement</span>
    <span class="n">dset_pfm</span><span class="p">,</span> <span class="n">dset_chns</span><span class="p">,</span> <span class="n">dset_cs</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">raster_scan</span><span class="p">(</span><span class="n">raster_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tip_voltage&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scan_pixel&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> 
                                                                           <span class="s2">&quot;scan_x_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;scan_y_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
                                                                           <span class="s2">&quot;scan_x_stop&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;scan_y_stop&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
                                                      <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;Domain_wall_width&quot;</span><span class="p">,</span> <span class="n">ploton</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">,</span> <span class="n">ax6</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Q Factor&quot;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_chns</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Topography&quot;</span><span class="p">)</span>
    <span class="n">ax6</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_chns</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Deflection&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="experiment-3-spiral-scans">
<h2>Experiment 3. Spiral Scans<a class="headerlink" href="#experiment-3-spiral-scans" title="Permalink to this heading">#</a></h2>
<p>AEcroscopy allows various scan trajectories, such as spiral, lissajour scans, as well as arbitrary scan. Here we show examples of spiral scan in band excitation PFM, however, these scan trajectories can also be used in other experiment, such as KPFM (ref [])</p>
<section id="id2">
<h3>Prior to expeirment, set a directory to save data<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;C:/AEcroscopy_manuscript/Experiment3&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-1-set-be-pulse-parameters">
<h3>Step 1. Set BE pulse parameters<a class="headerlink" href="#step-1-set-be-pulse-parameters" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set BE pulse amplitude</span>
<span class="n">newexp</span><span class="o">.</span><span class="n">define_be_parms</span><span class="p">(</span><span class="n">be_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;center_frequency_Hz_00&quot;</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span> <span class="s2">&quot;band_width_Hz_01&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;amplitude_V_02&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                       <span class="n">do_create_be_waveform</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-2-perform-a-raster-scan-as-a-reference-to-compare-with-spiral-and-lissajour-scan-results">
<h3>Step 2. Perform a raster scan as a reference to compare with spiral and lissajour scan results.<a class="headerlink" href="#step-2-perform-a-raster-scan-as-a-reference-to-compare-with-spiral-and-lissajour-scan-results" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform BEPFM image measurement</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">dset_pfm</span><span class="p">,</span> <span class="n">dset_chns</span><span class="p">,</span> <span class="n">dset_cs</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">raster_scan</span><span class="p">(</span><span class="n">raster_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tip_voltage&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scan_pixel&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
                                                                       <span class="s2">&quot;scan_x_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;scan_y_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
                                                                       <span class="s2">&quot;scan_x_stop&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;scan_y_stop&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
                                                  <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;Domain_wall_width&quot;</span><span class="p">,</span> <span class="n">ploton</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">timecost_raster</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="c1"># Plot raster scan result</span>
<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Q Factor&quot;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-3-perform-a-spiral-scan-bepfm">
<h3>Step 3. Perform a spiral scan BEPFM<a class="headerlink" href="#step-3-perform-a-spiral-scan-bepfm" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># newexp.fpga_spiral_scan(spiral_parms_dict = {&quot;spiral_inner_radius_x_V_00&quot;: 0, &quot;spiral_outer_radius_x_V_01&quot;: 1,</span>
<span class="c1">#                                              &quot;spiral_inner_radius_y_V_02&quot;: 0, &quot;spiral_outer_radius_y_V_03&quot;: 1,</span>
<span class="c1">#                                              &quot;spiral_N_cycles_04&quot;: 10, &quot;spiral_duration_05&quot;: 1}, </span>
<span class="c1">#                         do_scan_update = True, do_scan = False, </span>
<span class="c1">#                         file_name = &quot;spiral_scan&quot;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpgaresult = newexp.fpga_spiral_scan(do_scan_update = True, do_scan = True, file_name = &quot;spiral_scan&quot;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># spiral scan BEPFM</span>
<span class="n">newexp</span><span class="o">.</span><span class="n">fpga_spiral_scan_BE</span><span class="p">(</span><span class="n">spiral_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;spiral_inner_radius_x_V_00&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span><span class="s2">&quot;spiral_outer_radius_x_V_01&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                                <span class="s2">&quot;spiral_inner_radius_y_V_02&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span><span class="s2">&quot;spiral_outer_radius_y_V_03&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                                <span class="s2">&quot;spiral_N_cycles_04&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                           <span class="n">num_BE_pulse</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">do_scan_update</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="n">do_BE_arb_line_update_00</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">do_BE_arb_line_scan_01</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># spiral scan BEPFM</span>
<span class="n">fpga_result</span><span class="p">,</span> <span class="n">be_result</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">fpga_spiral_scan_BE</span><span class="p">(</span><span class="n">spiral_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;spiral_inner_radius_x_V_00&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                                                                         <span class="s2">&quot;spiral_outer_radius_x_V_01&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                                                         <span class="s2">&quot;spiral_inner_radius_y_V_02&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                                                                         <span class="s2">&quot;spiral_outer_radius_y_V_03&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                                                         <span class="s2">&quot;spiral_N_cycles_04&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">},</span>
                                                    <span class="n">num_BE_pulse</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span> <span class="n">do_scan_update</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                                                    <span class="n">do_BE_arb_line_update_00</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">do_BE_arb_line_scan_01</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">spiral_reconstruction</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">timecost_spiral</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="c1"># # Plot spiral BE results</span>
<span class="c1"># # be = be_result[&#39;reconstruction&#39;]</span>
<span class="c1"># f, (ax1, ax2, ax3, ax4) = plt.subplots(1, 4, figsize = (20, 5), dpi = 100)</span>
<span class="c1"># ax1.imshow(be[:,:,0], origin = &quot;lower&quot;); ax1.set_title(&quot;Amplitude&quot;)</span>
<span class="c1"># ax2.imshow(be[:,:,1], origin = &quot;lower&quot;); ax2.set_title(&quot;Frequency&quot;)</span>
<span class="c1"># ax3.imshow(be[:,:,2], origin = &quot;lower&quot;); ax3.set_title(&quot;Q Factor&quot;)</span>
<span class="c1"># ax4.imshow(be[:,:,3], origin = &quot;lower&quot;); ax4.set_title(&quot;Phase&quot;)</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># Spiral reconstruction function</span>
    <span class="k">def</span> <span class="nf">newspiral_be_reconstruction</span><span class="p">(</span><span class="n">sho_guess_cluster</span><span class="p">,</span> <span class="n">output_xy</span><span class="p">,</span> <span class="n">image_mask</span><span class="p">,</span> <span class="n">sample_factor</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> 
                                 <span class="n">num_image_pixels</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">itern</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lambd</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cut_thresh</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="c1"># BE line data</span>
        <span class="n">sho_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sho_guess_cluster</span><span class="p">)</span>
            
        <span class="c1"># Sample</span>
        <span class="n">output_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">output_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">outx_downsampled</span> <span class="o">=</span> <span class="n">output_x</span><span class="p">[::</span><span class="n">output_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">sho_guess</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">sample_factor</span><span class="p">]</span>
        <span class="n">outy_downsampled</span> <span class="o">=</span> <span class="n">output_y</span><span class="p">[::</span><span class="n">output_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">sho_guess</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">sample_factor</span><span class="p">]</span>
        <span class="n">outx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">outx_downsampled</span><span class="p">))</span>
        <span class="n">outy_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">outy_downsampled</span><span class="p">))</span>
        <span class="n">xy_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">outx_max</span><span class="p">,</span> <span class="n">outy_max</span><span class="p">])</span>

        <span class="c1">#The x and y positions are to convert to in pixels</span>
        <span class="n">x_downsampled</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">outx_downsampled</span> <span class="o">*</span> <span class="n">num_image_pixels</span><span class="o">/</span><span class="n">outx_max</span> <span class="o">+</span> <span class="n">num_image_pixels</span><span class="p">)</span>
        <span class="n">y_downsampled</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">outy_downsampled</span> <span class="o">*</span> <span class="n">num_image_pixels</span><span class="o">/</span><span class="n">outy_max</span> <span class="o">+</span> <span class="n">num_image_pixels</span><span class="p">)</span>

        <span class="n">sho_amp</span> <span class="o">=</span> <span class="n">sho_guess</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sho_pha</span> <span class="o">=</span> <span class="n">sho_guess</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">new_us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sho_amp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sho_amp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sample_factor</span><span class="p">)</span>
        <span class="n">sho_amp_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_us</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sho_amp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sho_amp</span><span class="p">)</span>
        <span class="n">sho_pha_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_us</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sho_pha</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sho_pha</span><span class="p">)</span>

        <span class="n">z_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">image_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sho_amp_interp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cut_thresh</span><span class="p">)):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x_downsampled</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_downsampled</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">image_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">z_img</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sho_amp_interp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mf">1E3</span>
            <span class="n">z_img</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sho_pha_interp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="n">mask_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">z_img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z_img</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">mask_</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">#Now do CS reconstructions</span>
        <span class="n">reconstructions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reconstruction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SSTEM</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z_img</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]),</span> <span class="n">mask_</span><span class="p">,</span> <span class="n">itern</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">lambd</span><span class="p">)</span>
                <span class="n">reconstructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;reconstruction failed in </span><span class="si">{}</span><span class="s2"> iterations&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">reconstructions</span><span class="p">,</span> <span class="n">z_img</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">be_line_result</span> <span class="o">=</span><span class="n">newexp</span><span class="o">.</span><span class="n">VI</span><span class="o">.</span><span class="n">getcontrolvalue</span><span class="p">(</span><span class="s2">&quot;BE_line_scan_indicator_cluster&quot;</span><span class="p">)</span>
<span class="n">sho_guess_cluster</span> <span class="o">=</span> <span class="n">be_line_result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">output_xy</span> <span class="o">=</span> <span class="p">[</span><span class="n">newexp</span><span class="o">.</span><span class="n">VIs</span><span class="o">.</span><span class="n">getcontrolvalue</span><span class="p">(</span><span class="s1">&#39;AO0_V&#39;</span><span class="p">),</span> <span class="n">newexp</span><span class="o">.</span><span class="n">VIs</span><span class="o">.</span><span class="n">getcontrolvalue</span><span class="p">(</span><span class="s1">&#39;AO1_V&#39;</span><span class="p">)]</span>
<span class="n">image_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newexp</span><span class="o">.</span><span class="n">VIs</span><span class="o">.</span><span class="n">getcontrolvalue</span><span class="p">(</span><span class="s2">&quot;image_mask&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reconstructions</span><span class="p">,</span> <span class="n">piezo_list</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span> <span class="n">num_points_image</span> <span class="o">=</span> <span class="n">get_be_cs_scan_data</span><span class="p">(</span><span class="n">newexp</span><span class="p">,</span> 
                                                                             <span class="n">piezo_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> 
                                                                             <span class="n">upsample_factor</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">lambd</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">itern</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;levels </span><span class="si">{}</span><span class="s2">, itern </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">j</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">reconstructions</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">get_be_cs_scan_data</span><span class="p">(</span><span class="n">newexp</span><span class="p">,</span> 
                                                         <span class="n">piezo_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                         <span class="n">upsample_factor</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">lambd</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">itern</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">recon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">reconstructions</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">recon</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">recon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">reconstructions</span><span class="p">)</span>
<span class="n">recon</span><span class="o">.</span><span class="n">shape</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">recon</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reconstructions</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">get_be_cs_scan_data</span><span class="p">(</span><span class="n">newexp</span><span class="p">,</span> 
                             <span class="n">piezo_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                             <span class="n">upsample_factor</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">lambd</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">itern</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reconstructions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">reconstructions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reconstructions</span><span class="p">,</span> <span class="n">z_img</span> <span class="o">=</span> <span class="n">newspiral_be_reconstruction</span><span class="p">(</span><span class="n">sho_guess_cluster</span><span class="p">,</span> <span class="n">output_xy</span><span class="p">,</span> <span class="n">image_mask</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">z_img</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @jit(nopython=True)</span>
<span class="k">def</span> <span class="nf">return_zimg</span><span class="p">(</span><span class="n">z_img</span><span class="p">,</span> <span class="n">sho_amp_interp</span><span class="p">,</span> <span class="n">sho_ph_interp</span><span class="p">,</span> <span class="n">x_downsampled</span><span class="p">,</span> <span class="n">y_downsampled</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">cut_thresh</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sho_amp_interp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cut_thresh</span><span class="p">)):</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x_downsampled</span><span class="p">[</span><span class="n">ind</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_downsampled</span><span class="p">[</span><span class="n">ind</span><span class="p">])]</span>
        <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z_img</span><span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sho_amp_interp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="mf">1E3</span>
        <span class="n">z_img</span><span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sho_ph_interp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">z_img</span>

<span class="c1"># @jit(nopython=True)</span>
<span class="k">def</span> <span class="nf">return_mask</span><span class="p">(</span><span class="n">z_img</span><span class="p">,</span> <span class="n">mask_new</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z_img</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mask_new</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">mask_new</span>

<span class="kn">import</span> <span class="nn">pywt</span>

<span class="k">def</span> <span class="nf">SSTEM</span><span class="p">(</span><span class="n">yspar</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">itern</span><span class="p">,</span><span class="n">levels</span><span class="p">,</span><span class="n">lambd</span><span class="p">):</span>  
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    INPUT: </span>
<span class="sd">        -yspar: sparse image as an array, to reduce iteration numer, better rescaling the value to [0,1]</span>
<span class="sd">        -mask: binary array, 1 indicationg sampled pixel locations</span>
<span class="sd">        -itern: iteration number, usually 20 is enough</span>
<span class="sd">        -levels: wavelet level, common choice 2,3,4, larger value for larger feature size, if too blur, change to smaller one</span>
<span class="sd">        -lambd: threshold value, usually 0.8 is fine</span>
<span class="sd">    OUTPUT: </span>
<span class="sd">        -Reconstructed image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">fSpars</span> <span class="o">=</span> <span class="n">yspar</span>
    <span class="n">W_thr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">levels</span><span class="p">;</span>

    <span class="n">ProjC</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">Omega</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Omega</span><span class="p">)</span><span class="o">*</span><span class="n">f</span> <span class="o">+</span> <span class="n">Omega</span><span class="o">*</span><span class="n">yspar</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">itern</span><span class="p">):</span>
        <span class="n">fSpars</span> <span class="o">=</span> <span class="n">ProjC</span><span class="p">(</span><span class="n">fSpars</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">W_pro</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">swt2</span><span class="p">(</span><span class="n">fSpars</span><span class="p">,</span> <span class="s1">&#39;db2&#39;</span><span class="p">,</span><span class="n">levels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">levels</span><span class="p">):</span>
            <span class="n">sA</span> <span class="o">=</span> <span class="n">W_pro</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sH</span> <span class="o">=</span> <span class="n">W_pro</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sV</span> <span class="o">=</span> <span class="n">W_pro</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sD</span> <span class="o">=</span> <span class="n">W_pro</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">W_thr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pywt</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">sA</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;soft&#39;</span><span class="p">)),(</span><span class="n">pywt</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">sH</span><span class="p">,</span><span class="n">lambd</span><span class="p">,</span><span class="s1">&#39;soft&#39;</span><span class="p">),</span>
                        <span class="n">pywt</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">sV</span><span class="p">,</span><span class="n">lambd</span><span class="p">,</span><span class="s1">&#39;soft&#39;</span><span class="p">),</span><span class="n">pywt</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">sD</span><span class="p">,</span><span class="n">lambd</span><span class="p">,</span><span class="s1">&#39;soft&#39;</span><span class="p">))</span>    
        <span class="n">fSpars</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">iswt2</span><span class="p">(</span><span class="n">W_thr</span><span class="p">,</span><span class="s1">&#39;db2&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fSpars</span>

<span class="k">def</span> <span class="nf">line_scan_data</span><span class="p">(</span><span class="n">VI_ref</span><span class="p">):</span>
    <span class="n">line_data</span> <span class="o">=</span> <span class="n">VI_ref</span><span class="o">.</span><span class="n">getcontrolvalue</span><span class="p">(</span><span class="s1">&#39;BE_line_scan_indicator_cluster&#39;</span><span class="p">)</span>
    <span class="n">daq_wave</span> <span class="o">=</span> <span class="n">line_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">complex_spectra</span> <span class="o">=</span> <span class="n">line_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">shoguessfit</span> <span class="o">=</span> <span class="n">line_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">topo</span> <span class="o">=</span> <span class="n">line_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">daq_wave</span><span class="p">,</span> <span class="n">complex_spectra</span><span class="p">,</span> <span class="n">shoguessfit</span><span class="p">,</span> <span class="n">topo</span>

<span class="k">def</span> <span class="nf">get_be_cs_scan_data</span><span class="p">(</span><span class="n">acquisition_handle</span><span class="p">,</span> <span class="n">piezo_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                        <span class="n">upsample_factor</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">lambd</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">itern</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">acquisition_handle</span><span class="o">.</span><span class="n">VIs</span><span class="o">.</span><span class="n">getcontrolvalue</span><span class="p">(</span><span class="s2">&quot;image_mask&quot;</span><span class="p">))</span>
    <span class="n">num_points_image</span> <span class="o">=</span> <span class="n">acquisition_handle</span><span class="o">.</span><span class="n">VIs</span><span class="o">.</span><span class="n">getcontrolvalue</span><span class="p">(</span><span class="s1">&#39;N_image_pixels&#39;</span><span class="p">)</span>
    
    <span class="n">daq_wave</span><span class="p">,</span> <span class="n">complex_spectra</span><span class="p">,</span> <span class="n">shoguessfit</span><span class="p">,</span> <span class="n">topo</span> <span class="o">=</span> <span class="n">line_scan_data</span><span class="p">(</span><span class="n">acquisition_handle</span><span class="o">.</span><span class="n">VI</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">piezo_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ao0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">acquisition_handle</span><span class="o">.</span><span class="n">VIs</span><span class="o">.</span><span class="n">getcontrolvalue</span><span class="p">(</span><span class="s1">&#39;AO0_V&#39;</span><span class="p">))</span>
        <span class="n">ao1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">acquisition_handle</span><span class="o">.</span><span class="n">VIs</span><span class="o">.</span><span class="n">getcontrolvalue</span><span class="p">(</span><span class="s1">&#39;AO1_V&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ao0</span> <span class="o">=</span> <span class="n">piezo_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ao1</span> <span class="o">=</span> <span class="n">piezo_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
    <span class="n">sho_qf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shoguessfit</span><span class="p">)</span>
    <span class="n">reconstructions</span><span class="p">,</span><span class="n">piezo_list</span> <span class="o">=</span> <span class="n">do_CS_for_BE</span><span class="p">(</span><span class="n">sho_qf</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span> <span class="n">ao0</span><span class="p">,</span><span class="n">ao1</span><span class="p">,</span> <span class="n">num_points_image</span><span class="p">,</span>
                                              <span class="n">upsample_factor</span><span class="o">=</span><span class="n">upsample_factor</span><span class="p">,</span> <span class="n">lambd</span><span class="o">=</span><span class="n">lambd</span><span class="p">,</span>
                                             <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">itern</span> <span class="o">=</span> <span class="n">itern</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">reconstructions</span><span class="p">,</span> <span class="n">piezo_list</span><span class="p">,</span> <span class="n">sho_qf</span><span class="p">,</span> <span class="n">complex_spectra</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">num_points_image</span>

<span class="k">def</span> <span class="nf">do_CS_for_BE</span><span class="p">(</span><span class="n">sho_qf</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">ao0</span><span class="p">,</span><span class="n">ao1</span><span class="p">,</span><span class="n">num_points_image</span><span class="p">,</span><span class="n">upsample_factor</span><span class="p">,</span> <span class="n">itern</span><span class="p">,</span>
                 <span class="n">levels</span><span class="p">,</span><span class="n">lambd</span><span class="p">,</span> <span class="n">cut_thresh</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
    
    <span class="n">ao0_downsampled</span> <span class="o">=</span> <span class="n">ao0</span><span class="p">[::</span><span class="n">ao0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">sho_qf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">upsample_factor</span><span class="p">]</span>
    <span class="n">ao1_downsampled</span> <span class="o">=</span> <span class="n">ao1</span><span class="p">[::</span><span class="n">ao1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">sho_qf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">upsample_factor</span><span class="p">]</span>

    <span class="n">max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ao0_downsampled</span><span class="p">))</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ao1_downsampled</span><span class="p">))</span>
    <span class="n">max_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">])</span>

    <span class="c1">#since the offsets don&#39;t matter, the x and y positions are straightforward to convert to in pixels</span>
    <span class="n">x_downsampled</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ao0</span><span class="p">[::</span><span class="n">ao0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">sho_qf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">upsample_factor</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_points_image</span><span class="o">/</span><span class="n">max_value</span> <span class="o">+</span> <span class="n">num_points_image</span><span class="p">)</span>
    <span class="n">y_downsampled</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ao1</span><span class="p">[::</span><span class="n">ao0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">sho_qf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">upsample_factor</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_points_image</span><span class="o">/</span><span class="n">max_value</span> <span class="o">+</span> <span class="n">num_points_image</span><span class="p">)</span>

    <span class="n">sho_amp</span> <span class="o">=</span> <span class="n">sho_qf</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">sho_phase</span> <span class="o">=</span> <span class="n">sho_qf</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">new_us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sho_amp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sho_amp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upsample_factor</span><span class="p">)</span>
    <span class="n">sho_amp_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_us</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sho_amp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sho_amp</span><span class="p">)</span>
    <span class="n">sho_ph_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_us</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sho_amp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sho_phase</span><span class="p">)</span>

    <span class="n">z_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">z_img</span> <span class="o">=</span> <span class="n">return_zimg</span><span class="p">(</span><span class="n">z_img</span><span class="p">,</span> <span class="n">sho_amp_interp</span><span class="p">,</span><span class="n">sho_ph_interp</span><span class="p">,</span> <span class="n">x_downsampled</span><span class="p">,</span> <span class="n">y_downsampled</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">cut_thresh</span><span class="p">)</span>
    <span class="n">mask_ph</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">z_img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">mask_new</span> <span class="o">=</span> <span class="n">return_mask</span><span class="p">(</span><span class="n">z_img</span><span class="p">,</span><span class="n">mask_ph</span><span class="p">)</span>
    
    <span class="c1">#Now do CS</span>
    <span class="n">reconstructions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recons</span><span class="o">=</span><span class="n">SSTEM</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z_img</span><span class="p">[:,:,</span><span class="n">ind</span><span class="p">]),</span><span class="n">mask_new</span><span class="p">,</span><span class="n">itern</span><span class="p">,</span><span class="n">levels</span><span class="p">,</span><span class="n">lambd</span><span class="p">)</span>
            <span class="n">reconstructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recons</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
       <span class="c1"># reconstructions.append(recons)</span>
        
    <span class="k">return</span> <span class="n">reconstructions</span><span class="p">,</span> <span class="p">[</span><span class="n">x_downsampled</span><span class="p">,</span><span class="n">y_downsampled</span><span class="p">,</span> <span class="n">ao0_downsampled</span><span class="p">,</span><span class="n">ao1_downsampled</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_next_action</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">piezo_vp_list</span><span class="p">):</span>
    
    <span class="n">x_downsampled</span><span class="p">,</span><span class="n">y_downsampled</span><span class="p">,</span><span class="n">a0_downsampled</span><span class="p">,</span><span class="n">a1_downsampled</span>  <span class="o">=</span> <span class="n">piezo_vp_list</span>
    <span class="n">pix</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">ini_wall_pos</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_sigmoid_wall</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">clip_inds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pix</span><span class="o">*</span><span class="mf">0.20</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pix</span><span class="o">*</span><span class="mf">0.80</span><span class="p">)])</span>
    
    <span class="c1">#Now randomly apply voltage and pulse widths</span>
    <span class="n">ypos_pix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.3</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">high</span> <span class="o">=</span> <span class="mf">0.7</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span> <span class="o">+</span><span class="mi">10</span>
    <span class="n">xpos_pix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ini_wall_pos</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ypos_pix</span><span class="p">)])</span><span class="o">+</span><span class="mi">10</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;xpos_pix </span><span class="si">{}</span><span class="s1">, ypos_pix </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xpos_pix</span><span class="p">,</span> <span class="n">ypos_pix</span><span class="p">))</span>
    
    <span class="n">x_downsampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_downsampled</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">y_downsampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_downsampled</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
    
    <span class="n">xpos_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xpos_pix</span><span class="o">==</span><span class="n">y_downsampled</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ypos_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ypos_pix</span><span class="o">==</span><span class="n">x_downsampled</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">xpos_v</span> <span class="o">=</span> <span class="n">a0_downsampled</span><span class="p">[</span><span class="n">xpos_ind</span><span class="p">]</span>
        <span class="n">ypos_v</span> <span class="o">=</span> <span class="n">a1_downsampled</span><span class="p">[</span><span class="n">xpos_ind</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">xpos_v</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ypos_v</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="n">voltage_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">pulse_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span><span class="o">*</span><span class="mf">1E-3</span>
    
    <span class="n">next_action</span> <span class="o">=</span> <span class="p">[</span><span class="n">ypos_pix</span><span class="p">,</span><span class="n">xpos_pix</span><span class="p">,</span><span class="n">xpos_v</span><span class="p">,</span><span class="n">ypos_v</span><span class="p">,</span><span class="n">voltage_value</span><span class="p">,</span><span class="n">pulse_width</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">next_action</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

<span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">parms</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">Offset</span> <span class="o">=</span> <span class="n">parms</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">b</span><span class="p">)))</span> <span class="o">+</span> <span class="n">Offset</span>

<span class="k">def</span> <span class="nf">rev_sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">parms</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">Offset</span> <span class="o">=</span> <span class="n">parms</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">b</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">b</span><span class="p">)))</span> <span class="o">+</span> <span class="n">Offset</span>


<span class="k">def</span> <span class="nf">norm_image</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">arr</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_sigmoid_wall</span><span class="p">(</span><span class="n">phase_profile</span><span class="p">,</span> <span class="n">clip_inds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">80</span><span class="p">],</span>
                     <span class="n">ind</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">clip_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clip_inds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">phase_profile</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    
    <span class="n">phase_cons</span> <span class="o">=</span> <span class="n">phase_profile</span><span class="p">[:,</span> <span class="n">clip_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">clip_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">clip_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">clip_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">prior_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">clip_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">clip_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    
    <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wall_pos</span><span class="p">,</span> <span class="n">wall_width</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phase_cons</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">yvals</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase_cons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">phase_cons</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">phase_cons</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">fit_values</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">rev_sigmoid</span><span class="p">,</span> <span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">prior_b</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">maxfev</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span>
  
                <span class="n">wall_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">wall_width</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            
            <span class="k">except</span><span class="p">:</span>

                <span class="n">wall_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">wall_width</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">yvals</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase_cons</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">phase_cons</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">phase_cons</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">fit_values</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">rev_sigmoid</span><span class="p">,</span> <span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">prior_b</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">maxfev</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span>
            
            <span class="n">wall_pos</span> <span class="o">=</span> <span class="n">fit_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">wall_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">fit_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Im not there&#39;</span><span class="p">)</span>
            <span class="n">wall_pos</span><span class="p">,</span> <span class="n">wall_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
            
    <span class="k">return</span> <span class="n">wall_pos</span><span class="p">,</span> <span class="n">wall_width</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sho_guess_cluster</span><span class="p">)</span>

<span class="n">sho</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sho</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fgparesult</span> <span class="o">=</span> <span class="n">fpga_result</span>
<span class="n">beresult</span> <span class="o">=</span> <span class="n">be_result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Compare the time cost of raster and spiral scan: &quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;time cost for raster scan is </span><span class="si">{}</span><span class="s2">s and for spiral scan is </span><span class="si">{}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timecost_raster</span><span class="p">,</span> <span class="n">timecost_spiral</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="experiment-4-spectroscopy-measurements-at-specific-objects">
<h2>Experiment 4. Spectroscopy Measurements at Specific Objects<a class="headerlink" href="#experiment-4-spectroscopy-measurements-at-specific-objects" title="Permalink to this heading">#</a></h2>
<p>AEcroscopy also enables spectroscopy at pre-defined objects in an automated manner, e.g. in-plane a-domains. Here we will show you how to perform piezoresonse spectroscopy measurements at only ferroelastic a-domains as an example. However, this can also be used in other spectroscopy modes (e.g., force-distance curve, current-voltage curve) and to measure other objects (e.g., domain wall, grain boundary).</p>
<section id="id3">
<h3>Prior to expeirment, set a directory to save data<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;D:\WEST User data\Yongtao\AEcroscopy\Experiment3&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-1-perform-a-bepfm-to-image-domain-structures">
<h3>Step 1. Perform a BEPFM to image domain structures<a class="headerlink" href="#step-1-perform-a-bepfm-to-image-domain-structures" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dset_pfm</span><span class="p">,</span> <span class="n">dset_chns</span><span class="p">,</span> <span class="n">dset_cs</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">raster_scan</span><span class="p">(</span><span class="n">raster_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tip_voltage&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scan_pixel&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
                                                                       <span class="s2">&quot;scan_x_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;scan_y_start&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
                                                                       <span class="s2">&quot;scan_x_stop&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;scan_y_stop&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
                                                  <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;BEPFM_structure_3um&quot;</span><span class="p">,</span> <span class="n">ploton</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1"># plot results</span>
<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Q Factor&quot;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [progress: 0:22:51] |************************************* | (ETA:   0:00:05) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
</pre></div>
</div>
<img alt="_images/8c78387c53de30bb8aebb7cbc0dd685dd86447e58e26377348d981d8c38d9d3d.png" src="_images/8c78387c53de30bb8aebb7cbc0dd685dd86447e58e26377348d981d8c38d9d3d.png" />
</div>
</div>
</section>
<section id="step-2-apply-a-threshold-filter-to-extract-a-domain-location-from-amplitude-image">
<h3>Step 2. Apply a threshold filter to extract a-domain location from amplitude image<a class="headerlink" href="#step-2-apply-a-threshold-filter-to-extract-a-domain-location-from-amplitude-image" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># normalize amplitude image</span>
<span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dset_pfm</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">amplitude_nor</span> <span class="o">=</span> <span class="p">(</span><span class="n">amplitude</span> <span class="o">-</span> <span class="n">amplitude</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="n">amplitude</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span>

<span class="c1"># apply a threshold filter</span>
<span class="n">thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">amplitude_nor</span><span class="p">)</span>
<span class="n">th</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">thresh</span><span class="p">[</span><span class="n">amplitude_nor</span> <span class="o">&lt;</span> <span class="n">th</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># set a-domain locations as 1</span>
<span class="n">thresh</span><span class="p">[</span><span class="n">amplitude_nor</span> <span class="o">&gt;=</span> <span class="n">th</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># set non a-domain locations as 0</span>

<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span> <span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">amplitude_nor</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">thresh</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Threshold Image&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6c5f5772e80f786275d2773b63a53efe3ccdc431f51b24746404aede2a3deac1.png" src="_images/6c5f5772e80f786275d2773b63a53efe3ccdc431f51b24746404aede2a3deac1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select some random locations from a-domain to perform BEPS measurement</span>
<span class="n">adomain_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">thresh</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="c1"># select 10 random location</span>
<span class="n">random_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">adomain_locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
<span class="n">selected_locations_a</span> <span class="o">=</span> <span class="n">adomain_locations</span><span class="p">[:,</span><span class="n">random_idx</span><span class="p">]</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;locations_a.npy&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">selected_locations_a</span><span class="p">))</span>

<span class="c1"># select some random locations from c-domain to perform BEPS measurement</span>
<span class="n">cdomain_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">thresh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<span class="c1"># select 10 random location</span>
<span class="n">random_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">cdomain_locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">selected_locations_c</span> <span class="o">=</span> <span class="n">cdomain_locations</span><span class="p">[:,</span><span class="n">random_idx</span><span class="p">]</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;locations_c.npy&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">selected_locations_c</span><span class="p">))</span>

<span class="c1"># plot selected locations</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">thresh</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">selected_locations_a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">selected_locations_a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">selected_locations_c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">selected_locations_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d7d595e68259ed6e21bc74a7447d0bc43e12b2944269a09560c31cc1a508eff5.png" src="_images/d7d595e68259ed6e21bc74a7447d0bc43e12b2944269a09560c31cc1a508eff5.png" />
</div>
</div>
</section>
<section id="step-3-perform-beps-measurements-at-selected-locations">
<h3>Step 3. Perform BEPS measurements at selected locations<a class="headerlink" href="#step-3-perform-beps-measurements-at-selected-locations" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define BEPS parameters</span>
<span class="n">newexp</span><span class="o">.</span><span class="n">define_BEPS_parameters</span><span class="p">(</span><span class="n">beps_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;amplitude_V_00&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;step_per_cycle_03&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
                                                <span class="s2">&quot;num_cycles_04&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="n">do_create_waveform</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BEPS parameters are:  (20.0, 0.0, 0.0, 64, 3, 0, 0, 0, 0.001, 0.0, 0.0, 0.0, 1, 0, 8.0, 8.0, 7.0, -7.0, False, False, False)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert coordinates in image to tip location values</span>
<span class="n">convert_locations</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">convert_coordinates</span><span class="p">(</span><span class="n">original_coordinates</span><span class="o">=</span><span class="n">selected_locations_a</span><span class="p">,</span> <span class="n">num_pix_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_pix_y</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

<span class="c1"># Perform BEPS at each location</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">convert_locations</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">wv</span><span class="p">,</span> <span class="n">quick_fit</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">chns</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">do_beps_specific</span><span class="p">(</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">convert_locations</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">convert_locations</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]]),</span>
                                                     <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;BEPS_at_A_domain_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert coordinates in image to tip location values</span>
<span class="n">convert_locations</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">convert_coordinates</span><span class="p">(</span><span class="n">original_coordinates</span><span class="o">=</span><span class="n">selected_locations_c</span><span class="p">,</span> <span class="n">num_pix_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_pix_y</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

<span class="c1"># Perform BEPS at each location</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">convert_locations</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">wv</span><span class="p">,</span> <span class="n">quick_fit</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">chns</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">do_beps_specific</span><span class="p">(</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">convert_locations</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">convert_locations</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]]),</span>
                                                     <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;BEPS_at_C_domain_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
 [progress: 0:00:03] |                                      | (ETA:  --:--:--) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">amp_off_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">192</span><span class="p">))</span>
<span class="n">amp_on_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">192</span><span class="p">))</span>
<span class="n">pha_off_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">192</span><span class="p">))</span>
<span class="n">pha_on_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">192</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">convert_locations</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">&quot;BEPS_at_A_domain_</span><span class="si">{}</span><span class="s2">_0.hf5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    <span class="c1">#sidpy.hdf.hdf_utils.print_tree(hf)</span>
    <span class="n">vw</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s2">&quot;BEPS/vdc_waveform&quot;</span><span class="p">]</span>
    <span class="n">vw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

    <span class="n">amp</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s2">&quot;BE Quick Fitting/Quick Fitting/Quick Fitting&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,]</span>
    <span class="n">pha</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s2">&quot;BE Quick Fitting/Quick Fitting/Quick Fitting&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">192</span><span class="p">):</span>
        <span class="n">amp_off_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">amp_on_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pha_off_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pha</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">pha_on_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pha</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">amp_off_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">192</span><span class="p">))</span>
<span class="n">amp_on_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">192</span><span class="p">))</span>
<span class="n">pha_off_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">192</span><span class="p">))</span>
<span class="n">pha_on_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">192</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">convert_locations</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">&quot;BEPS_at_C_domain_</span><span class="si">{}</span><span class="s2">_0.hf5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    <span class="c1">#sidpy.hdf.hdf_utils.print_tree(hf)</span>
    <span class="n">vw</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s2">&quot;BEPS/vdc_waveform&quot;</span><span class="p">]</span>
    <span class="n">vw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

    <span class="n">amp</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s2">&quot;BE Quick Fitting/Quick Fitting/Quick Fitting&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,]</span>
    <span class="n">pha</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s2">&quot;BE Quick Fitting/Quick Fitting/Quick Fitting&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">192</span><span class="p">):</span>
        <span class="n">amp_off_c</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">amp_on_c</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pha_off_c</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pha</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">pha_on_c</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pha</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">amp_off_c</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;c domain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">amp_off_a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;a domain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x2435dd38dc0&gt;
</pre></div>
</div>
<img alt="_images/8e6a1a0eb84f206f87d96a199d13abb4c5cbda1896fe70d5138ce9268201ffa6.png" src="_images/8e6a1a0eb84f206f87d96a199d13abb4c5cbda1896fe70d5138ce9268201ffa6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">amp_c</span> <span class="o">=</span> <span class="n">amp_off_c</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">pha_c</span> <span class="o">=</span> <span class="n">pha_off_c</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">piezo_c</span> <span class="o">=</span> <span class="n">amp_c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pha_c</span><span class="p">)</span>
<span class="n">amp_a</span> <span class="o">=</span> <span class="n">amp_off_a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">pha_a</span> <span class="o">=</span> <span class="n">pha_off_a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">piezo_a</span> <span class="o">=</span> <span class="n">amp_a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pha_a</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">piezo_c</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;c domain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">piezo_a</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;a domain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x243612f5190&gt;
</pre></div>
</div>
<img alt="_images/0bae68fcb0852908612c0e3256643535ffc5a344a0e13ceeb66c18a3d9807b35.png" src="_images/0bae68fcb0852908612c0e3256643535ffc5a344a0e13ceeb66c18a3d9807b35.png" />
</div>
</div>
</section>
<section id="step-3-2-perform-grid-beps-measurements">
<h3>Step 3-2. Perform grid BEPS measurements<a class="headerlink" href="#step-3-2-perform-grid-beps-measurements" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wv</span><span class="p">,</span> <span class="n">quick_fit</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">chns</span> <span class="o">=</span> <span class="n">newexp</span><span class="o">.</span><span class="n">do_beps_grid</span><span class="p">(</span><span class="n">beps_grid_parms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pixel_num_x&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;pixel_num_y&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                                              <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;BEPS_grid&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [progress: 0:05:26] |************************************* | (ETA:   0:00:03) C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
C:\Users\Asylum User\anaconda3\lib\site-packages\pyNSID\io\hdf_utils.py:376: FutureWarning: validate_h5_dimension may be removed in a future version
  warn(&#39;validate_h5_dimension may be removed in a future version&#39;,
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">&quot;BEPS_grid_0.hf5&quot;</span><span class="p">)</span>
<span class="c1">#sidpy.hdf.hdf_utils.print_tree(hf)</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s2">&quot;BEPS/vdc_waveform&quot;</span><span class="p">]</span>
<span class="n">vw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

<span class="n">amp</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s2">&quot;BE Quick Fitting/Quick Fitting/Quick Fitting&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,]</span>
<span class="n">amp_mean</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">amp_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">192</span><span class="p">)</span>
<span class="n">amp_on</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">192</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">192</span><span class="p">):</span>
    <span class="n">amp_off</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp_mean</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">amp_on</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp_mean</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vw</span><span class="p">,</span> <span class="n">amp_on</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Voltage (V)&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Amplitude (a.u.)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/875020394e8cadd4175c715b706d37376ec1086a05553c10e753e20c39115a10.png" src="_images/875020394e8cadd4175c715b706d37376ec1086a05553c10e753e20c39115a10.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-and-import">Install and Import</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#start-bepyae-exe-and-set-vi">Start BEPyAE.exe and set VI</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initialize-igor-ar18">Initialize Igor AR18</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-tip-parameters">Set tip parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-io">Set IO</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-be-pulse-parameters">Set BE pulse parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#be-line-scan">BE Line scan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#be-raster-scan">BE Raster Scan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-1-high-throughput-domain-writing-in-ferroelectric-materials">Experiment 1. High-throughput domain writing in ferroelectric materials</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prior-to-expeirment-set-a-directory-to-save-data">Prior to expeirment, set a directory to save data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-generate-a-location-array">Step 1. Generate a location array</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-establish-pulse-parameters">Step 2. Establish pulse parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-start-experiment">Step 3. Start experiment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-do-a-bepfm-at-the-whole-experiment-area">Step 4. Do a BEPFM at the whole experiment area</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-2-ferroelectric-domain-wall-width-as-a-function-of-drive-amplitude-and-setpoint">Experiment 2. Ferroelectric Domain Wall Width as a Function of Drive Amplitude and Setpoint</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Prior to expeirment, set a directory to save data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-establish-ac-amplitude-and-setpoint-parameters">Step 1. Establish AC Amplitude and Setpoint Parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-write-a-domain-wall">Step 2. Write a Domain Wall</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-perform-bepfm-to-image-the-domain-wall-with-various-ac-and-setpoint">Step 3. Perform BEPFM to image the domain wall with various AC and setpoint</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-3-spiral-scans">Experiment 3. Spiral Scans</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Prior to expeirment, set a directory to save data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-set-be-pulse-parameters">Step 1. Set BE pulse parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-perform-a-raster-scan-as-a-reference-to-compare-with-spiral-and-lissajour-scan-results">Step 2. Perform a raster scan as a reference to compare with spiral and lissajour scan results.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-perform-a-spiral-scan-bepfm">Step 3. Perform a spiral scan BEPFM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-4-spectroscopy-measurements-at-specific-objects">Experiment 4. Spectroscopy Measurements at Specific Objects</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Prior to expeirment, set a directory to save data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-perform-a-bepfm-to-image-domain-structures">Step 1. Perform a BEPFM to image domain structures</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-apply-a-threshold-filter-to-extract-a-domain-location-from-amplitude-image">Step 2. Apply a threshold filter to extract a-domain location from amplitude image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-perform-beps-measurements-at-selected-locations">Step 3. Perform BEPS measurements at selected locations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-2-perform-grid-beps-measurements">Step 3-2. Perform grid BEPS measurements</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Yongtao Liu
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      Â© Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>